#!/bin/bash

. nmwiz_var
. nmwiz_list >/dev/null
nmwiz_check

delete() {
    if [ -z "${FULL_ADDR+x}" ]; then
        imessage "[ SELECT ] email account"
        list_acc
        read -r INPUT
        MATCH="^$INPUT"
    else
        MATCH=" $FULL_ADDR$"
        get_acc
    fi

    FULL_ADDR="$(echo "$ACCOUNTS" | grep "$MATCH" | cut -d' ' -f2)"

    [ -z "$FULL_ADDR" ] &&
        emessage "[ ERROR ] invalid account name" &&
        return 1

    sed -ibu "/IMAPStore $FULL_ADDR-remote$/,/# end profile/d" "$MBSYNCRC_LOC"
    rm -rf "${CACHE_DIR:?}/${FULL_ADDR:?}" "$ACC_DIR/"[1-9]"-$FULL_ADDR.muttrc"

    sed -ibu "/[0-9]-$FULL_ADDR.muttrc/d" "$MUTTRC_LOC"
    rm -rf "$MUTTRC_LOC"bu

    sed -ibu "/[0-9]-$FULL_ADDR/,/^\(\s*$\|account\)/d" "$MSMTPRC_LOC"
    rm -rf "$MSMTPRC_LOC"bu

    pass rm -f "$PASSWORD_PREFIX$FULL_ADDR" > /dev/null 2>&1

    for file in "$MSMTPRC_LOC" "$MBSYNCRC_LOC"; do
        tr '\n' '|' < "$file" | sed "s/||\+/||/g" | tr '|' '\n' >> "$file"bu
        mv -f "$file"bu "$file"
    done
}

echo
delete
